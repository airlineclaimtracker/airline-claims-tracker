<script>
        // Global variables
        let currentImage = null;
        let originalImage = null;
        let selectedStyle = 'classic';
        let currentPlatform = 'twitter';
        let claimData = {};
        let currentImageRotation = 0;
        
        // Platform-specific message templates - UPDATED with enhanced messaging
        const messageTemplates = {
            twitter: `Day {days}. Still waiting for @SmartwingsGroup to respond.

Is this customer service?

€{amount} luggage claim filed {date}.
Response: SILENCE

#StillWaiting #Smartwings #AirlineAccountability #CustomerService

How long should passengers wait?`,

            linkedin: `I'm sharing this to highlight a customer service issue that affects all travelers.

After {days} days, Smartwings still hasn't responded to my €{amount} luggage claim filed on {date}.

The question isn't just about one claim – it's about basic service standards. Is this customer service?

When airlines ignore legitimate claims, it affects trust in the entire industry.

#CustomerService #AirlineAccountability #Travel #Smartwings`,

            facebook: `Day {days} and still waiting...

Is this customer service? You decide.

✈️ Smartwings flight damaged my luggage
💶 €{amount} compensation claim filed {date}
📞 Response from Smartwings: SILENCE

How long should passengers wait for basic acknowledgment?

#StillWaiting #Smartwings #CustomerService`,

            instagram: `📖 Day {days} Update

❓ Is this customer service?

💼 Luggage destroyed on @smartwings_official flight
💶 €{amount} claim filed: {date}  
📞 Their response: Complete silence

Basic question: How long should customers wait?

#StillWaiting #CustomerService #TravelFails #Smartwings #AirlineAccountability

Story continues...`
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeYears();
            setupEventListeners();
        });
        
        function initializeYears() {
            const yearSelect = document.getElementById('submission-year');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear; year >= currentYear - 4; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        function setupEventListeners() {
            const uploadContainer = document.getElementById('upload-container');
            const fileInput = document.getElementById('file-input');
            
            // File input change
            fileInput.addEventListener('change', handleFileSelect);
            document.getElementById('camera-input').addEventListener('change', handleFileSelect);
            
            // Drag and drop - Safari specific
            uploadContainer.addEventListener('dragenter', handleDragEnter, false);
            uploadContainer.addEventListener('dragover', handleDragOver, false);
            uploadContainer.addEventListener('dragleave', handleDragLeave, false);
            uploadContainer.addEventListener('drop', handleDrop, false);
            
            // Click to upload
            uploadContainer.addEventListener('click', function(e) {
                if (e.target === uploadContainer || e.target.closest('.upload-text') || e.target.closest('.upload-hint')) {
                    fileInput.click();
                }
            });
        }
        
        // Safari-optimized drag and drop
        function handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('upload-container').classList.add('dragging');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Check if we're really leaving the container
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX;
            const y = e.clientY;
            
            if (x < rect.left || x >= rect.right || y < rect.top || y >= rect.bottom) {
                document.getElementById('upload-container').classList.remove('dragging');
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('upload-container').classList.remove('dragging');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleFileUpload(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFileUpload(file);
            }
        }
        
        function openCamera() {
            document.getElementById('camera-input').click();
        }
        
        // Safari-optimized file upload
        function handleFileUpload(file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Please select an image under 5MB.');
                return;
            }
            
            showProgress(true);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                currentImage = e.target.result;
                originalImage = e.target.result;
                currentImageRotation = 0;
                
                // Show success state
                const uploadContainer = document.getElementById('upload-container');
                uploadContainer.classList.add('has-photo');
                uploadContainer.innerHTML = `
                    <div class="upload-icon">✅</div>
                    <div class="upload-text">Photo uploaded successfully</div>
                    <div class="upload-hint">${file.name}</div>
                `;
                
                // Show preview
                showImagePreview();
                showProgress(false);
            };
            
            reader.onerror = function() {
                showProgress(false);
                alert('Error reading file. Please try again.');
            };
            
            reader.readAsDataURL(file);
        }
        
        function showProgress(show) {
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            if (show) {
                progressBar.classList.remove('hidden');
                progressFill.style.width = '0%';
                
                // Simulate progress
                let progress = 0;
                const timer = setInterval(() => {
                    progress += 10;
                    progressFill.style.width = progress + '%';
                    if (progress >= 100) {
                        clearInterval(timer);
                        setTimeout(() => {
                            progressBar.classList.add('hidden');
                        }, 500);
                    }
                }, 100);
            } else {
                progressBar.classList.add('hidden');
            }
        }
        
        function showImagePreview() {
            const previewArea = document.getElementById('photo-preview-area');
            const previewImg = document.getElementById('preview-image');
            
            previewImg.src = currentImage;
            previewArea.classList.add('visible');
            
            // Update card preview if form is already submitted
            if (claimData.days) {
                updateCardPreview();
            }
        }
        
        function rotateImage() {
            currentImageRotation = (currentImageRotation + 90) % 360;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Set canvas dimensions based on rotation
                if (currentImageRotation === 90 || currentImageRotation === 270) {
                    canvas.width = img.height;
                    canvas.height = img.width;
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Apply rotation
                ctx.save();
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(currentImageRotation * Math.PI / 180);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
                
                // Update current image
                currentImage = canvas.toDataURL('image/jpeg', 0.9);
                
                // Update preview
                document.getElementById('preview-image').src = currentImage;
                
                // Update card if necessary
                if (claimData.days) {
                    updateCardPreview();
                }
            };
            
            img.src = originalImage;
        }
        
        function removeImage() {
            currentImage = null;
            originalImage = null;
            currentImageRotation = 0;
            
            // Reset upload container
            const uploadContainer = document.getElementById('upload-container');
            uploadContainer.classList.remove('has-photo');
            uploadContainer.innerHTML = `
                <div class="upload-icon">📷</div>
                <div class="upload-text">Drag your photo here</div>
                <div class="upload-hint">or click to select from device</div>
                
                <div class="upload-methods">
                    <button type="button" class="upload-btn" onclick="document.getElementById('file-input').click()">
                        📁 Choose File
                    </button>
                    <button type="button" class="upload-btn secondary" onclick="openCamera()">
                        📸 Take Photo
                    </button>
                </div>
            `;
            
            // Clear file input
            document.getElementById('file-input').value = '';
            document.getElementById('camera-input').value = '';
            
            // Hide preview
            document.getElementById('photo-preview-area').classList.remove('visible');
            
            // Update card
            if (claimData.days) {
                updateCardPreview();
            }
        }
        
        // Calculate days since submission
        function calculateDaysSince(month, year) {
            const submissionDate = new Date(year, month - 1, 1);
            const today = new Date();
            const diffTime = Math.abs(today - submissionDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // Format date
        function formatDate(month, year) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[month - 1]} ${year}`;
        }
        
        // Select card style
        function selectCardStyle(style) {
            selectedStyle = style;
            document.querySelectorAll('.card-variant').forEach(v => v.classList.remove('selected'));
            document.querySelector(`[data-style="${style}"]`).classList.add('selected');
            
            if (claimData.days) {
                applyCardStyle();
            }
        }
        
        // UPDATED: Apply card style with enhanced brand accountability section
        function applyCardStyle() {
            const cardContent = document.querySelector('.card-content');
            const cardPhoto = document.querySelector('.card-photo-section');
            const brandAccountability = document.querySelector('.brand-accountability');
            const viralHeader = document.querySelector('.viral-header');
            const responseLine = document.querySelector('.response-line');
            
            switch(selectedStyle) {
                case 'bold':
                    cardContent.style.background = 'linear-gradient(135deg, #000, #333)';
                    cardPhoto.style.background = 'linear-gradient(135deg, #000, #333)';
                    viralHeader.textContent = 'IGNORED FOR';
                    responseLine.textContent = 'Status: IGNORED';
                    // Keep the brand accountability section as is for maximum contrast
                    break;
                    
                case 'minimal':
                    cardContent.style.background = 'linear-gradient(135deg, #f8f9fa, #e9ecef)';
                    cardContent.style.color = '#333';
                    cardPhoto.style.background = 'linear-gradient(135deg, #e9ecef, #dee2e6)';
                    brandAccountability.style.background = 'rgba(230, 57, 70, 0.95)';
                    viralHeader.textContent = 'Still Waiting';
                    responseLine.textContent = 'Response: None';
                    document.querySelectorAll('.hashtag').forEach(h => h.style.color = '#e63946');
                    document.querySelector('.days-counter').style.color = '#e63946';
                    document.querySelector('.days-label').style.color = '#e63946';
                    break;
                    
                default: // classic
                    cardContent.style.background = 'linear-gradient(135deg, #e63946, #d63031)';
                    cardContent.style.color = 'white';
                    cardPhoto.style.background = 'linear-gradient(135deg, #e63946, #d63031)';
                    brandAccountability.style.background = 'rgba(0,0,0,0.95)';
                    brandAccountability.style.color = 'white';
                    viralHeader.textContent = 'STILL WAITING';
                    responseLine.textContent = 'Response: SILENCE';
                    document.querySelectorAll('.hashtag').forEach(h => h.style.color = '#FFD93D');
                    document.querySelector('.days-counter').style.color = '#FFD93D';
                    document.querySelector('.days-label').style.color = '#FFD93D';
            }
        }
        
        // Show platform content
        function showPlatform(platform) {
            currentPlatform = platform;
            document.querySelectorAll('.platform-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showPlatform('${platform}')"]`).classList.add('active');
            
            updatePlatformMessage();
        }
        
        // Update platform message
        function updatePlatformMessage() {
            if (!claimData.days) return;
            
            let message = messageTemplates[currentPlatform];
            message = message.replace(/{days}/g, claimData.days);
            message = message.replace(/{amount}/g, claimData.amount);
            message = message.replace(/{date}/g, claimData.date);
            
            document.getElementById('platform-content').textContent = message;
        }
        
        // Copy message to clipboard
        function copyMessage() {
            const message = document.getElementById('platform-content').textContent;
            
            // Safari-compatible clipboard
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(message).then(() => {
                    showCopyFeedback();
                }).catch(() => {
                    // Fallback for Safari
                    fallbackCopyTextToClipboard(message);
                });
            } else {
                fallbackCopyTextToClipboard(message);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const result = document.execCommand('copy');
                if (result) {
                    showCopyFeedback();
                } else {
                    alert('Failed to copy text. Please copy manually.');
                }
            } catch (err) {
                alert('Failed to copy text. Please copy manually.');
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopyFeedback() {
            const feedback = document.getElementById('copy-feedback');
            feedback.style.display = 'block';
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 3000);
        }
        
        // Handle form submission
        document.getElementById('claim-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const month = parseInt(document.getElementById('submission-month').value);
            const year = parseInt(document.getElementById('submission-year').value);
            const amount = document.getElementById('amount').value;
            
            if (!month || !year || !amount) {
                alert('Please fill in all required fields');
                return;
            }
            
            const days = calculateDaysSince(month, year);
            claimData = {
                days: days,
                amount: amount,
                date: formatDate(month, year)
            };
            
            // Update preview
            document.getElementById('preview-days').textContent = days;
            document.getElementById('preview-amount').textContent = amount;
            document.getElementById('preview-date').textContent = claimData.date;
            
            // Apply selected style
            applyCardStyle();
            
            // Update card photo if available
            updateCardPreview();
            
            // Show preview
            document.getElementById('preview').classList.add('visible');
            
            // Generate message for default platform
            showPlatform('twitter');
            
            // Scroll to preview
            document.getElementById('preview').scrollIntoView({ behavior: 'smooth' });
        });
        
        function updateCardPreview() {
            const cardPhoto = document.getElementById('card-luggage-photo');
            const defaultIcon = document.getElementById('default-luggage');
            
            if (currentImage) {
                cardPhoto.src = currentImage;
                cardPhoto.style.display = 'block';
                defaultIcon.style.display = 'none';
            } else {
                cardPhoto.style.display = 'none';
                defaultIcon.style.display = 'block';
            }
        }
        
        // Share functions
        function shareToTwitter() {
            currentPlatform = 'twitter';
            updatePlatformMessage();
            const message = document.getElementById('platform-content').textContent;
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
        
        function shareToFacebook() {
            currentPlatform = 'facebook';
            updatePlatformMessage();
            const message = document.getElementById('platform-content').textContent;
            const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
        
        function shareToInstagram() {
            downloadCard();
            currentPlatform = 'instagram';
            updatePlatformMessage();
            const message = document.getElementById('platform-content').textContent;
            setTimeout(() => {
                alert(`Image downloaded! 📸\n\nTo share on Instagram:\n1. Upload the downloaded image\n2. Copy this caption:\n\n${message}`);
            }, 1000);
        }
        
        function shareToLinkedIn() {
            currentPlatform = 'linkedin';
            updatePlatformMessage();
            const message = document.getElementById('platform-content').textContent;
            
            // Copy message to clipboard
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(message).then(() => {
                    linkedInFlow();
                }).catch(() => {
                    fallbackCopyTextToClipboard(message);
                    linkedInFlow();
                });
            } else {
                fallbackCopyTextToClipboard(message);
                linkedInFlow();
            }
            
            function linkedInFlow() {
                // Download image
                downloadCard();
                
                // Open LinkedIn
                const url = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(window.location.href);
                window.open(url, '_blank');
                
                // Show instructions
                setTimeout(() => {
                    alert('LinkedIn sharing:\n\n✅ Text copied to clipboard\n✅ Image downloading\n📱 LinkedIn opened in new tab\n\nNow just:\n• Paste the text (⌘+V)\n• Upload the downloaded image\n• Click "Post"');
                }, 1000);
            }
        }
        
        // Safari-optimized download function
        function downloadCard() {
            // Simple screenshot approach for Safari
            const card = document.getElementById('claim-card');
            
            // Try html2canvas if available
            if (typeof html2canvas !== 'undefined') {
                html2canvas(card, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: true
                }).then(canvas => {
                    downloadCanvas(canvas);
                }).catch(err => {
                    console.error('html2canvas error:', err);
                    manualDownloadFallback();
                });
            } else {
                // Load html2canvas dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    html2canvas(card, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        allowTaint: true
                    }).then(canvas => {
                        downloadCanvas(canvas);
                    }).catch(err => {
                        console.error('html2canvas error:', err);
                        manualDownloadFallback();
                    });
                };
                script.onerror = function() {
                    manualDownloadFallback();
                };
                document.head.appendChild(script);
            }
        }
        
        function downloadCanvas(canvas) {
            try {
                const link = document.createElement('a');
                link.download = `smartwings-claim-day-${claimData.days}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // Safari download workaround
                if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
                    link.target = '_blank';
                }
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error('Download error:', err);
                manualDownloadFallback();
            }
        }
        
        function manualDownloadFallback() {
            alert('Download not available in this browser. You can take a screenshot of the card below instead.');
        }
        
        // Error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('JavaScript error:', msg, url, lineNo, columnNo, error);
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
    
    <!-- Load html2canvas for Safari -->
    <script>
        // Preload html2canvas for Safari compatibility
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.async = true;
        document.head.appendChild(script);
    </script>
</body>
</html>
